<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Marmitaria - Interface de Teste</title>
    <link rel="stylesheet" href="./styles.css">
</head>
<body>
    <div class="container">
        <div class="config-warning" id="configWarning">
            ‚ö†Ô∏è ATEN√á√ÉO: Configure a URL do webhook no c√≥digo
        </div>

        <div class="header">
            <h2>üç± Marmitaria Sabor Caseiro</h2>
            <p>Atendimento inteligente via IA</p>
        </div>

        <div id="messages"></div>
        <div class="loading" id="loading">Digitando</div>

        <div class="input-area">
            <input
                type="text"
                id="messageInput"
                placeholder="Digite sua mensagem..."
                autocomplete="off"
            >
            <button onclick="sendMessage()" id="sendBtn">Enviar</button>
        </div>
    </div>

    <script>
        const WEBHOOK_URL = 'https://nexttech-n8n-nexthub.haas2a.easypanel.host/webhook/marmitaria-chat';
        const SESSION_ID = 'web-' + Date.now();
        let NOME = '';
        let conversationStarted = false;

        if (WEBHOOK_URL.includes('SEU_N8N')) {
            document.getElementById('configWarning').classList.add('show');
        }

        function addMessage(text, type = 'bot') {
            const messagesDiv = document.getElementById('messages');
            const div = document.createElement('div');
            div.className = 'message ' + type;
            const safeText = text || '';
            div.innerHTML = safeText.replace(/\n/g, '<br>');
            messagesDiv.appendChild(div);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function showLoading(show) {
            const loading = document.getElementById('loading');
            const sendBtn = document.getElementById('sendBtn');
            const input = document.getElementById('messageInput');

            loading.classList.toggle('show', show);
            sendBtn.disabled = show;
            input.disabled = show;
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            if (!message) return;

            if (!conversationStarted) {
                NOME = message;
                conversationStarted = true;
                addMessage(message, 'user');
                input.value = '';
                setTimeout(() => {
                    addMessage(`Ol√°, ${NOME}! Que bom ter voc√™ aqui na Marmitaria Sabor Caseiro. üòä\n\nComo posso te ajudar hoje?\n\nüìã Ver o card√°pio completo\nüç± Fazer um pedido\nüí¨ Tirar d√∫vidas`, 'bot');
                }, 600);
                return;
            }

            addMessage(message, 'user');
            input.value = '';
            showLoading(true);

            try {
                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        nome: NOME,
                        session_id: SESSION_ID
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                showLoading(false);

                const mensagem = data.mensagem || '';
                if (mensagem) {
                    addMessage(mensagem, 'bot');
                }

            } catch (error) {
                showLoading(false);
                let errorMsg = '‚ùå Erro ao enviar mensagem.\n\n';

                if (WEBHOOK_URL.includes('SEU_N8N')) {
                    errorMsg += '‚ö†Ô∏è Configure a URL do webhook no c√≥digo!';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMsg += 'üîå N√£o foi poss√≠vel conectar ao servidor.\n\nVerifique:\n‚Ä¢ URL do webhook\n‚Ä¢ Workflow ativo\n‚Ä¢ CORS configurado';
                } else {
                    errorMsg += `Detalhes: ${error.message}`;
                }

                addMessage(errorMsg, 'system error');
            }
        }

        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        window.addEventListener('load', () => {
            addMessage('Ol√°! Seja bem-vindo(a) √† Marmitaria Sabor Caseiro! üëã', 'bot');
            setTimeout(() => {
                addMessage('Eu sou o assistente virtual e vou te ajudar a fazer seu pedido.\n\nPara come√ßar, qual √© o seu nome?', 'bot');
            }, 800);
            document.getElementById('messageInput').focus();
        });

        window.addEventListener('beforeunload', (e) => {
            if (conversationStarted && NOME) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>
</body>
</html>
